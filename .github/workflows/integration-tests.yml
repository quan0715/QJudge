name: Integration Tests

# 整合測試（需要完整的 docker-compose.test.yml 環境）
# - Frontend API Integration Tests
# - E2E Tests (Playwright)

on:
  # 手動觸發
  workflow_dispatch:
    inputs:
      test_type:
        description: "Test type to run"
        required: true
        default: "all"
        type: choice
        options:
          - api-only
          - e2e-only
          - all
      debug_enabled:
        description: "Run with debug logging"
        required: false
        default: "false"

  # 自動觸發
  push:
    branches: [main, develop]
    paths:
      - "frontend/src/services/**"
      - "frontend/tests/e2e/**"
      - "backend/apps/**/views.py"
      - "backend/apps/**/serializers.py"
      - "docker-compose.test.yml"
      - ".github/workflows/integration-tests.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "frontend/src/services/**"
      - "frontend/tests/e2e/**"
      - "backend/apps/**/views.py"
      - "backend/apps/**/serializers.py"
      - "docker-compose.test.yml"

jobs:
  # ============================================
  # 整合測試 (單一 Job 確保 Docker 環境共享)
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # 啟動測試環境
      # ============================================
      - name: Start Database and Redis
        run: |
          docker compose -f docker-compose.test.yml up -d postgres-test redis-test
          echo "Waiting for database and redis..."
          sleep 10

      - name: Start Backend
        run: |
          docker compose -f docker-compose.test.yml up -d backend-test
          echo "Waiting for backend to start..."

      - name: Wait for Backend Health
        run: |
          for i in {1..60}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/v1/auth/me || echo "000")
            if [ "$STATUS" -ge "200" ] && [ "$STATUS" -lt "500" ]; then
              echo "✅ Backend is ready! (HTTP $STATUS)"
              exit 0
            fi
            echo "Waiting for backend... ($i/60) - Status: $STATUS"
            sleep 2
          done
          echo "❌ Backend failed to start"
          docker compose -f docker-compose.test.yml logs backend-test
          exit 1

      # ============================================
      # Frontend API 整合測試
      # ============================================
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: frontend

      - name: Run API Integration Tests
        if: github.event.inputs.test_type != 'e2e-only'
        env:
          API_BASE_URL: http://localhost:8001
        run: npm run test:api
        working-directory: frontend

      # ============================================
      # E2E 測試 (Playwright)
      # ============================================
      - name: Cache Playwright Browsers
        if: github.event.inputs.test_type != 'api-only'
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright Browsers
        if: github.event.inputs.test_type != 'api-only' && steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium webkit
        working-directory: frontend

      - name: Install Playwright Dependencies (if cached)
        if: github.event.inputs.test_type != 'api-only' && steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium webkit
        working-directory: frontend

      - name: Start Frontend Test Server
        if: github.event.inputs.test_type != 'api-only'
        run: |
          docker compose -f docker-compose.test.yml up -d frontend-test
          for i in {1..30}; do
            if curl -sf http://localhost:5174/ > /dev/null 2>&1; then
              echo "✅ Frontend is ready!"
              exit 0
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done
          echo "❌ Frontend failed to start"
          docker compose -f docker-compose.test.yml logs frontend-test
          exit 1

      - name: Run Auth E2E Tests
        if: github.event.inputs.test_type != 'api-only'
        env:
          E2E_REUSE_ENV: "true"
          CI: "true"
        run: npx playwright test -c playwright.config.e2e.ts tests/e2e/auth.e2e.spec.ts --reporter=html,list
        working-directory: frontend

      - name: Run Problems E2E Tests
        if: github.event.inputs.test_type != 'api-only'
        env:
          E2E_REUSE_ENV: "true"
          CI: "true"
        run: npx playwright test -c playwright.config.e2e.ts tests/e2e/problems.e2e.spec.ts --reporter=html,list
        working-directory: frontend

      - name: Run Submission E2E Tests
        if: github.event.inputs.test_type != 'api-only'
        env:
          E2E_REUSE_ENV: "true"
          CI: "true"
        run: npx playwright test -c playwright.config.e2e.ts tests/e2e/submission.e2e.spec.ts --reporter=html,list
        working-directory: frontend

      - name: Run Contest E2E Tests
        if: github.event.inputs.test_type != 'api-only'
        env:
          E2E_REUSE_ENV: "true"
          CI: "true"
        run: npx playwright test -c playwright.config.e2e.ts tests/e2e/contest.e2e.spec.ts --reporter=html,list
        working-directory: frontend
        continue-on-error: true

      # ============================================
      # 上傳測試報告
      # ============================================
      - name: Upload Playwright HTML Report
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.test_type != 'api-only'
        with:
          name: playwright-report-e2e
          path: frontend/playwright-report-e2e/
          retention-days: 30

      - name: Upload Test Results (screenshots, videos, traces)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-test-results
          path: frontend/test-results/
          retention-days: 14

      # ============================================
      # 清理
      # ============================================
      - name: Cleanup Docker Environment
        if: always()
        run: docker compose -f docker-compose.test.yml down -v
